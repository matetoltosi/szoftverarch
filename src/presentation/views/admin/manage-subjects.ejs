<h2>Manage Subjects</h2>

<div id="errorBox" class="error" style="display: none;"></div>

<form id="createSubjectForm">
  <input type="text" name="subjectName" id="subjectName" placeholder="Subject Name" required>
  <button type="submit">Create Subject</button>
</form>

<table>
  <thead>
    <tr>
      <th>Subject ID</th>
      <th>Name</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>

  </tbody>
</table>

<script>
  const errorBox = document.getElementById('errorBox');
  const form = document.getElementById('createSubjectForm');

  function showError(message) {
    errorBox.style.display = 'block';
    errorBox.textContent = message;
  }

  function clearError() {
    errorBox.style.display = 'none';
    errorBox.textContent = '';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const subjectName = document.getElementById('subjectName').value;

    try {
      const response = await fetch('/api/admin/subjects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: subjectName })
      });

      if (response.status === 409) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Subject with this name already exists.');
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Failed to create subject');
      }

      document.getElementById('subjectName').value = '';
      fetchSubjects();
    } catch (error) {
      showError(error.message);
    }
  });

  async function editSubject(subjectId) {
    const newName = prompt('Enter new subject name:');
    
    if (newName) {
      const result = await fetch(`/api/admin/subjects/${subjectId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
      });

      if (result.status === 409) {
        const errorData = await result.json();
        alert(errorData.message || 'Subject with this name already exists.');
        return;
      }
      
      if (!result.ok) {
        const errorData = await result.json();
        alert(errorData.message || 'Failed to update subject');
        return;
      }

      fetchSubjects();
    }
  }

  async function deleteSubject(subjectId) {
    if (confirm('Are you sure you want to delete this subject?')) {
      await fetch(`/api/admin/subjects/${subjectId}`, {
        method: 'DELETE'
      });
      fetchSubjects();
    }
  }

  async function fetchSubjects() {
    const response = await fetch('/api/admin/subjects');

    if (!response.ok) {
      showError('Failed to fetch subjects');
      return;
    }

    const subjects = await response.json();
    const tbody = document.querySelector('table tbody');
    tbody.innerHTML = '';

    subjects.forEach(subject => {
      const row = document.createElement('tr');

      const buttons = (subject.active) ? `
        <button onclick="editSubject('${subject._id}')">Edit</button>
        <button onclick="deleteSubject('${subject._id}')">Delete</button>
      ` : '';

      row.innerHTML = `
        <td>${subject._id}</td>
        <td>${subject.name}</td>
        <td>
          ${buttons}
        </td>
      `;
      
      if (!subject.active) {
        row.style.backgroundColor = '#f8d7da';
      }

      tbody.appendChild(row);
    });
  }

  fetchSubjects();
</script>